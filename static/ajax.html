<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <link rel="shortcut icon" type="image/ico" href="http://www.datatables.net/media/images/favicon.ico"/>

    <title>DataTables example</title>
    <style type="text/css" title="currentStyle">
        @import "/css/demo_page.css";
        @import "/css/demo_table.css";
    </style>

    <link rel="stylesheet" href="/css/ui-lightness/jquery-ui-1.10.4.custom.css">
    <link rel="stylesheet" href="/css/dropzone.css">

    <script type="text/javascript" language="javascript" src="/js/jquery-1.10.2.js"></script>
    <script type="text/javascript" language="javascript" src="/js/jquery-ui-1.10.4.js"></script>
    <script type="text/javascript" language="javascript" src="/js/jquery.dataTables.js"></script>
    <script type="text/javascript" language="javascript" src="/js/dropzone.js"></script>
    <script type="text/javascript" charset="utf-8">

        // коды окрасов кошек
        // http://cat.mau.ru/2/?p=code_all

        var db = {};

        function update_jsons(h){
            var db_keys = ['breeds', 'colors', 'details'];
            var k = 0;
            for(var i in db_keys){
                get_json(db_keys[i], function(){
                    if(++k==db_keys.length) h(true);
                });
            }
        }

        function get_json(fn, h){
            if(db[fn]) return;
            $.get('/jdb/'+fn+'.json', function(data) {
                db[fn] = data;
                h(true);
            });
        }

        function send_data(url, h){
            $.ajax({
                url : url,
                type: 'get',
                success : function (data) {
                    console.log(data);

                    if(data.error){
                        console.log(data);
                        h(false);
                        return;
                    }
                    h(data);
                },
                error : function(e){
                    console.log(e);
                    if(h) h(false);
                },
                timeout: 30000 // sets timeout to 30 seconds
            });
        }

        var oTable = null;
        var tableData = null;
        var changedData = {};

        $(document).ready(function () {
            /*var oTable = $('#example').dataTable({
                "bProcessing": true,
                //"sAjaxSource": "/arrays.txt"
                "sAjaxSource": "/admin"
            });*/

            $('#update').click(function(){
                //console.log(changedData);

                var updateData = [];
                for(var i in changedData){
                    var o = {};
                    for(var j in changedData[i]){
                        o[j] = changedData[i][j].val;
                    }
                    updateData.push(o);
                }

                $.ajax({
                    type: "POST",
                    url: '/add',
                    data: JSON.stringify(updateData),
                    contentType: "application/json; charset=utf-8",
                    dataType: 'json',
                    success: function(){
                        console.log('post', arguments);
                        send_data('/get', function(data){
                            tableData = data;
                            $('#reload').click();
                        });
                    },
                    error: function(){
                        console.log('error: post', arguments);
                    }
                });
            });

            $('#reload').click(function(){
                if(!tableData) return;

                // устанавливаю порядок полей
                var col_seq = ['type', 'group', 'race', 'color_code', 'color_description', 'details', 'sex', 'birth', 'father', 'mother', 'litter', 'name', 'state', 'details_description', 'Удалить', '_id'];
                var a = [];
                for(var i in tableData){
                    var o = {};
                    for(var j in col_seq){
                        o[col_seq[j]] = tableData[i][col_seq[j]];
                    }
                    // дорисовываю кнопку удалить
                    o['Удалить'] = 'Удалить';
                    a.push(o);
                }
                tableData = a;
                // \устанавливаю порядок полей

                var aoColumns = [];
                var aaData = [];
                for(var i in tableData){
                    var a = [];
                    var b = [];
                    for(var j in tableData[i]){
                        if('_id'==j) {
                            b.push( {
                                "sTitle": j,
                                "bSearchable": false,
                                "bVisible":    false
                            });
                            a.push(tableData[i][j]);
                        } else {
                            b.push( { "sTitle": j } );
                            a.push(tableData[i][j]);
                        }
                    }
                    aaData.push(a);
                    aoColumns = b;
                }

                // дорисовываю добавлялку нового
                var a = [];
                for(var i in aoColumns){
                    if('type'==aoColumns[i].sTitle){
                        a.push('создать');
                    } else {
                        a.push('');
                    }
                }
                aaData.push(a);

                var list_table = $('<table cellpadding="0" cellspacing="0" border="0" class="display"></table>');
                $('#list').html('');
                $('#list').append(list_table);

                oTable = list_table.dataTable({
                    "aaData": aaData,
                    "aoColumns": aoColumns,
                    "aaSorting" : [],
                    "fnDrawCallback": function () {
                        //console.log($(this).dataTable());

                        var table = $(this);

                        $('th', table).click(function(){
                            // анселекчю все активные эдиты
                            $('th', table).blur();
                        });

                        table.find('td').dblclick(function(){
                            var pos = oTable.fnGetPosition( this );
                            var td = $(this);
                            var tr = td.closest('tr');

                            var row = oTable.fnGetData(pos[0]);
                            var row_data = {}; // тут хранится новый измененный объект по этому row'ву
                            for(var i in aoColumns){
                                row_data[aoColumns[i].sTitle] = {
                                    val : row[i],
                                    id : i
                                };
                                //console.log( row_data[aoColumns[i].sTitle] );
                            }
                            //console.log('row_data', row_data);

                            if($('input', td).length) return;

                            //console.log(data[pos[0]]);
                            //console.log(aoColumns[pos[1]].sTitle);

                            var autocomplete_arr = [];
                            var text = td.html();
                            var input_id_name = aoColumns[pos[1]].sTitle;

                            console.log(input_id_name);
                            if('Удалить'==input_id_name) {
                                if(confirm('Удалить?')) {
                                    console.log(row);
                                    send_data('/del/'+row[row.length-1], function(){
                                        send_data('/get', function(data){
                                            tableData = data;
                                            $('#reload').click();
                                        });
                                    });
                                }
                                return;
                            }

                            var edit = $('<input type="text" class="editField" id="'+input_id_name+'">')
                                    .val(text)
                                    .focusout(function(){
                                        // смотрю чтобы не было пустым
                                        if(!edit.val() && (-1==['father', 'mother', 'litter'].indexOf(input_id_name))){
                                            if(text){
                                                edit.val(text||autocomplete_arr[0]);
                                            }
                                        }
                                        td.html(edit.val());
                                        if(text!=edit.val()){
                                            //tr.attr('changed', true);
                                            //tr.attr('id', 'tr_'+row_data);
                                            changedData[row_data._id.val] = row_data;

                                            console.log( 'text!=edit.val()', 'row_data', row_data );
                                            // обновляю связанные поля
                                            if('color_code'==input_id_name){
                                                var cd = $('td', tr).get(row_data.color_description.id);
                                                cd = $(cd);

                                                if(1==cd.length){
                                                    cd.val('');
                                                    oTable.fnUpdate( '', pos[0], row_data.color_description.id);
                                                }
                                            }
                                            if('group'==input_id_name){
                                                var cd = $('td', tr).get(row_data.race.id);
                                                cd = $(cd);

                                                if(1==cd.length){
                                                    cd.val('');
                                                    oTable.fnUpdate( '', pos[0], row_data.race.id);
                                                }
                                            }
                                            // \обновляю связанные поля

                                            // обновляю значение в таблице, т.к. поиск не будет находить измененные поля
                                            row_data[input_id_name].val = edit.val();
                                            oTable.fnUpdate( edit.val(), pos[0], pos[1]);
                                        }
                                    })
                                    .keypress(function(evt){
                                        //console.log( evt.charCode );
                                        if(13==evt.charCode){ // enter key
                                            edit.blur();
                                        }
                                        //console.log(arguments);
                                    })
                                    .keyup(function(evt) {
                                        if (evt.keyCode == 27) { // esc key
                                            td.html(text);
                                        }
                                    });

                            td.html('');
                            td.append(edit);
                            edit.focus();

                            // если кликнули на тип
                            if($('#type').length){
                                autocomplete_arr = ['кот', 'кошка', 'котёнок'];
                            }

                            // если кликнули на групу (короткошерст..)
                            if($('#group').length){
                                if(!db.breeds){
                                    console.log('no breeds!!!');
                                    return;
                                }

                                for(var i in db.breeds){
                                    autocomplete_arr.push(i);
                                }
                            }

                            // если кликнули на расу
                            if($('#race').length){
                                if(!db.breeds){
                                    console.log('error: no breeds!!!');
                                    return;
                                }

                                if(!db.breeds[row_data.group.val]){
                                    console.log('error" no db.breeds[row_data.group]', row_data.group);
                                    return;
                                }

                                for(var i in db.breeds[row_data.group.val]){
                                    if(0== i.indexOf('_')) continue;
                                    autocomplete_arr.push(i);
                                }
                            }

                            // если кликнули на пол
                            if($('#sex').length){
                                autocomplete_arr = ['male', 'female'];
                            }

                            if($('#color_description').length){
                                autocomplete_arr = [];
                                for(var i in row_data.color_code.val){
                                    var c = row_data.color_code.val[i];
                                    var colors = db.colors.color[c];
                                    if(!colors) continue;

                                    if(!autocomplete_arr.length) {
                                        autocomplete_arr = colors;
                                    } else {
                                        var a = [];
                                        for(var n in autocomplete_arr){
                                            for(var k in colors){
                                                a.push(autocomplete_arr[n]+'/'+colors[k]);
                                            }
                                        }
                                        autocomplete_arr = a;
                                    }
                                }

                                //console.log(autocomplete_arr);
                            }

                            if($('#color_code').length){
                                autocomplete_arr = [];

                                for(var i in db.colors.color){
                                    autocomplete_arr.push(''+i);
                                    for(var j in db.colors.color){
                                        if(i==j) continue;
                                        autocomplete_arr.push(j+''+i);
                                    }
                                }

                                autocomplete_arr.sort();
                            }

                            // если кликнули на отца
                            if($('#father').length){
                                autocomplete_arr = [];
                                for(var i in tableData){
                                    var d = tableData[i];

                                    if(d.sex=='female') continue;

                                    // исключаю из названий текущее название кота
                                    if(d.name==row_data.name.val){
                                        continue;
                                    }

                                    autocomplete_arr.push(d.name);
                                }
                            }

                            // если кликнуле на мать
                            if($('#mother').length){
                                autocomplete_arr = [];
                                for(var i in tableData){
                                    var d = tableData[i];

                                    if(d.sex=='male') continue;

                                    // исключаю из названий текущее название кота
                                    if(d.name==row_data.name.val){
                                        continue;
                                    }

                                    autocomplete_arr.push(d.name);
                                }
                            }

                            //---

                            switch(input_id_name){
                                case 'color_code':
                                    edit.autocomplete({
                                        source: function(req, response) {
                                            var a = [];
                                            for(var i in autocomplete_arr){
                                                if(req.term==autocomplete_arr[i][0]){
                                                    a.push(autocomplete_arr[i]);
                                                }
                                            }
                                            a.sort();

                                            response(a);
                                        },
                                        minLength: 1,
                                        max : 2
                                    });
                                    break;
                                default:
                                    edit.autocomplete({
                                        source: autocomplete_arr,
                                        minLength : 0
                                    });
                                    break;
                            }

                            //console.log( edit.autocomplete );

                            edit.on('focus', function() {
                                $(this).autocomplete("search", "");
                            });

                            edit.on('dblclick', function() {
                                $('#type').val('');
                                edit.focus();
                            });

                            edit.val('');
                            edit.focus();
                        });
                    }
                });

                var cat_names = [];
                for(var i in tableData){
                    var name = tableData[i].name;
                    if(name) cat_names.push(name);
                }

                $('#cat_name').autocomplete({
                    source: cat_names,
                    minLength : 0
                });
            });

            send_data('/get', function(data){
                tableData = data;

                update_jsons(function(){
                    $('#reload').click();
                    //console.log(db);
                });
            });

            $("div#my-dropzone").dropzone({
                url: "/upload",
                addRemoveLinks: true, // добавляю кнопку удалить
                //autoProcessQueue:false,
                init : function(){
                    var _this = this;
                    //console.log('mydropzone init', this);

                    $('#submit_cat_galery').click(function(){
                        //console.log(mydropzone.get(0).processQueue());
                        _this.processQueue();
                    });

                    _this.on("removedfile", function(file) {
                        console.log('removedfile', file);
                    });

                    _this.on("complete", function(file) {
                        console.log('complete', file);
                    });
                }
            });
        });
    </script>
</head>
<body>
<div id="container">
    <h1>Админ панель</h1>

    <h3 id="update">Update</h3>
    <h3 id="reload">Reload</h3>

    <!--div id="dynamic">
        <table cellpadding="0" cellspacing="0" border="0" class="display" id="example">
            <thead>
            <tr>
                <th>Rendering engine</th>
                <th>Browser</th>
                <th>Platform(s)</th>
                <th>Engine version</th>
                <th>CSS grade</th>
            </tr>
            </thead>
            <tbody>

            </tbody>
            <tfoot>
            <tr>
                <th>Rendering engine</th>
                <th>Browser</th>
                <th>Platform(s)</th>
                <th>Engine version</th>
                <th>CSS grade</th>
            </tr>
            </tfoot>
        </table>
    </div>
    <div class="spacer">
    </div-->
</div>
<div id="list"></div>
<br><hr>
<input id="cat_name" /><input type="button" id="submit_cat_galery" value="Загрузить все фото"/>
<div id="my-dropzone" class="dropzone"></div>

</body>
</html>