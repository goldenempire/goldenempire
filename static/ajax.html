<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <link rel="shortcut icon" type="image/ico" href="http://www.datatables.net/media/images/favicon.ico"/>

    <title>DataTables example</title>
    <style type="text/css" title="currentStyle">
        @import "/css/demo_page.css";
        @import "/css/demo_table.css";
    </style>

    <link rel="stylesheet" href="/css/ui-lightness/jquery-ui-1.10.4.custom.css">

    <script type="text/javascript" language="javascript" src="/js/jquery-1.10.2.js"></script>
    <script type="text/javascript" language="javascript" src="/js/jquery-ui-1.10.4.js"></script>
    <script type="text/javascript" language="javascript" src="/js/jquery.dataTables.js"></script>
    <script type="text/javascript" charset="utf-8">

        // коды окрасов кошек
        // http://cat.mau.ru/2/?p=code_all

        var cat_type = ['кот', 'кошка', 'котёнок'];

        var db = {};

        function update_jsons(h){
            var db_keys = ['breeds', 'colors', 'details'];
            var k = 0;
            for(var i in db_keys){
                get_json(db_keys[i], function(){
                    if(++k==db_keys.length) h(true);
                });
            }
        }

        function get_json(fn, h){
            if(db[fn]) return;
            $.get('/jdb/'+fn+'.json', function(data) {
                db[fn] = data;
                h(true);
            });
        }

        function send_data(url, h){
            $.ajax({
                url : url,
                type: 'get',
                success : function (data) {
                    if(data.error){
                        console.log(data);
                        h(false);
                        return;
                    }
                    h(data);
                },
                error : function(e){
                    console.log(e);
                    if(h) h(false);
                },
                timeout: 30000 // sets timeout to 30 seconds
            });
        }

        var oTable = null;
        var tableData = null;

        $(document).ready(function () {
            /*var oTable = $('#example').dataTable({
                "bProcessing": true,
                //"sAjaxSource": "/arrays.txt"
                "sAjaxSource": "/admin"
            });*/

            $('#add_new').click(function(){
                var t = oTable.fnSettings().aoColumns;
                var a = [];
                for(var i in t){
                    a.push( 'new '+t[i].sTitle );
                    //console.log(t[i].sTitle);

                    //oTable.fnDeleteRow(i);
                }

                oTable.fnClearTable(false);

                // добавляю поле для добавления
                oTable.fnAddData(a);
            });

            $('#show_all').click(function(){
                if(!tableData) return;

                var aoColumns = [];
                var aaData = [];
                for(var i in tableData){
                    var a = [];
                    var b = [];
                    for(var j in tableData[i]){
                        b.push( { "sTitle": j } );
                        a.push(tableData[i][j]);
                    }
                    aaData.push(a);
                    aoColumns = b;
                }

                var list_table = $('<table cellpadding="0" cellspacing="0" border="0" class="display"></table>');
                $('#list').html('');
                $('#list').append(list_table);

                oTable = list_table.dataTable({
                    "aaData": aaData,
                    "aoColumns": aoColumns,
                    "fnDrawCallback": function () {
                        //console.log($(this).dataTable());

                        var table = $(this);

                        $('th', table).click(function(){
                            // анселекчю все активные эдиты
                            $('th', table).blur();
                        });

                        table.find('td').dblclick(function(){
                            var pos = oTable.fnGetPosition( this );
                            var td = $(this);
                            var tr = td.closest('tr');

                            var row = oTable.fnGetData(pos[0]);
                            var row_data = {}; // тут хранится новый измененный объект по этому row'ву
                            for(var i in aoColumns){
                                row_data[aoColumns[i].sTitle] = row[i];
                            }

                            if($('input', td).length) return;


                            var curData = aaData;
                            if(!curData.length) curData = [curData];

                            //console.log(data[pos[0]]);

                            //console.log(aoColumns[pos[1]].sTitle);

                            var text = td.html();
                            var edit = $('<input type="text" class="editField" id="'+aoColumns[pos[1]].sTitle+'">')
                                    .val(text)
                                    .focusout(function(){
                                        td.html(edit.val());
                                        if(text!=edit.val()){
                                            td.closest('tr').attr('changed', true);

                                            // обновляю значение в таблице, т.к. поиск не будет находить измененные поля

                                            oTable.fnUpdate( edit.val(), pos[0], pos[1]);
                                        }
                                    })
                                    .keypress(function(evt){
                                        console.log( evt.charCode );
                                        if(13==evt.charCode){ // enter key
                                            edit.blur();
                                        }
                                        //console.log(arguments);
                                    })
                                    .keyup(function(evt) {
                                        if (evt.keyCode == 27) { // esc key
                                            td.html(text);
                                        }
                                    });

                            td.html('');
                            td.append(edit);
                            edit.focus();

                            // если кликнули на тип
                            if($('#type').length){
                                $('#type').autocomplete({
                                    source: cat_type,
                                    minLength : 0
                                });

                                $('#type').on('focus', function() {
                                    $(this).autocomplete("search", "");
                                });

                                $('#type').on('dblclick', function() {
                                    $('#type').val('');
                                    edit.focus();
                                });

                                $('#type').val('');
                                edit.focus();
                            }

                            // если кликнули на групу (короткошерст..)
                            if($('#group').length){
                                var group_type = [];
                                if(!db.breeds){
                                    console.log('no breeds!!!');
                                    return;
                                }

                                for(var i in db.breeds){
                                    group_type.push(i);
                                }


                                $('#group').autocomplete({
                                    source: group_type,
                                    minLength : 0
                                });
                                
                                $('#group').on('focus', function(event) {
                                    $(this).autocomplete("search", "");
                                });

                                $('#group').on('dblclick', function() {
                                    $('#group').val('');
                                    edit.focus();
                                });

                                $('#group').val('');
                                edit.focus();
                            }

                            // если кликнули на расу
                            if($('#race').length){
                                if(!db.breeds){
                                    console.log('error: no breeds!!!');
                                    return;
                                }

                                if(!db.breeds[row_data.group]){
                                    console.log('error" no db.breeds[row_data.group]', row_data.group);
                                    return;
                                }

                                var race_type = [];
                                for(var i in db.breeds[row_data.group]){
                                    if(0== i.indexOf('_')) continue;
                                    race_type.push(i);
                                }

                                $('#race').autocomplete({
                                    source: race_type,
                                    minLength : 0
                                });

                                $('#race').on('focus', function(event) {
                                    $(this).autocomplete("search", "");
                                });

                                $('#race').on('dblclick', function() {
                                    $('#race').val('');
                                    edit.focus();
                                });

                                $('#race').val('');
                                edit.focus();
                            }

                            // если кликнуле на отца
                            if($('#father').length){

                                var fatherSource = {};
                                for(var i in tableData){
                                    var d = tableData[i];

                                    console.log(d);

                                    if(!d.father) continue;

                                    fatherSource[d.father] = true;
                                }
                                fatherSource = Object.keys(fatherSource);

                                //console.log(fatherSource);

                                $('#father').autocomplete({
                                    source: fatherSource
                                });
                            }
                        });
                    }
                });
            });

            send_data('/all/ru', function(data){
                tableData = data;

                update_jsons(function(){
                    $('#show_all').click();
                });
            });
        });
    </script>
</head>
<body>
<div id="container">
    <h1>Админ панель</h1>

    <h3 id="add_new">New</h3>
    <h3 id="show_all">All</h3>

    <!--div id="dynamic">
        <table cellpadding="0" cellspacing="0" border="0" class="display" id="example">
            <thead>
            <tr>
                <th>Rendering engine</th>
                <th>Browser</th>
                <th>Platform(s)</th>
                <th>Engine version</th>
                <th>CSS grade</th>
            </tr>
            </thead>
            <tbody>

            </tbody>
            <tfoot>
            <tr>
                <th>Rendering engine</th>
                <th>Browser</th>
                <th>Platform(s)</th>
                <th>Engine version</th>
                <th>CSS grade</th>
            </tr>
            </tfoot>
        </table>
    </div>
    <div class="spacer">
    </div-->
</div>
<div id="list"></div>
<input id="tags">
</body>
</html>